co.nsoli.frameユーザマニュアル (マークアップ編)
========

概要
--------

co.nsoli.frameは、マークアップ・デザイン作業を効率化し、表示ロジックの実装、サーバサイド実装との効果的な分業をもたらします。

上記の目的を達成するために、下記の機能を持ちます。

- Java環境(1.6以上)があればどこでも動かすことができるポータブルな開発用サーバ(localhostを参照します)。
- マークアップのインクリメンタルな開発をサポートするプリプロセステンプレート継承機能。
- プリプロセスとクライアント実行時のそれぞれで実行されるテンプレート処理。
- プリプロセスに統合されたless.css等のコンパイル機能。

プリプロセス対象のソースファイルへの変更は、開発用サーバではリアルタイムに反映されます。  
また、運用環境に対してはプリコンパイル機能を使用してプリプロセス済の静的なファイルとして展開します。  
このため、運用環境に使用されるソリューション(PHP、ASP.net、CDN等)を選びません。

使用方法
--------

### 環境 ###

- JRE(Javaランタイムエンジン) 1.6以上がインストールされていること。

### 起動 ###

#### Windows ####

プロジェクトディレクトリのviewer.batを実行します。

#### Mac ####

プロジェクトディレクトリのviewer(シェルスクリプト)を実行します。  
実行権限がついていない場合は、実行権限を付与します。

### 画面 ###

メインウインドウ上部に2つの操作エリア、サーバエリアとプリコンパイルエリアが存在します。  
また、画面下部にはログが表示されます。

### 操作 ###

#### サーバ ####

プリプロセスに適用する、対象、環境(詳細は後述)を選択し、開発用サーバを起動するポート番号を指定します。

「開始」ボタンは開発用サーバの起動を行います。

「停止」ボタンは開発用サーバの停止を行います。

開発用サーバ起動後は、`http://localhost:ポート番号/`でドキュメントルートへアクセスされます。  
また、開発用サーバを起動したままプリプロセスのソースファイルを変更したものが反映されます。

#### プリコンパイル ####

プリプロセスに適用する、対象、環境(詳細は後述)を選択します。

「実行」ボタンはプリプロセスを行い、静的なファイルをプロジェクトディレクトリ内の「out」ディレクトリに出力します。

プリプロセス
--------

開発用サーバ及びプリコンパイルでは、プロジェクトの設定に基づいたファイル拡張子のマッピングが行われ、必要に応じてテンプレート処理、less.css等のコンパイルが実行されます。

### 共通ルール ###

ファイルの読込みについては共通して下記のルールが適用されます。

#### ドキュメントルート ####

ドキュメントルートは`web`ディレクトリです。

#### インクルードディレクトリ ####

テンプレート等でインクルードを行う場合は、`inc`ディレクトリがルートディレクトリとなります。

#### 対象・環境別の優先ファイル ####

開発用サーバ起動時・プリコンパイル時に指定された対象・環境がデフォルトでない場合は下記の順にファイルを探します。  

例: `/PATH/TO/FILE.NAME.EXT`が要求されたファイルの場合

- `/PATH/TO/FILE.NAME.対象@環境.EXT`
- `/PATH/TO/FILE.NAME.対象@.EXT`
- `/PATH/TO/FILE.NAME.@環境.EXT`
- `/PATH/TO/FILE.NAME.EXT`

### 拡張子別のルール ###

デフォルトの設定では下記のマッピングが行われます。

#### `*/` (`/`止めのリクエスト) ####

同ディレクトリ内の`default.html`へリダイレクトします。

#### `*.html` ####

拡張子を`.htpl`に変換したファイルが`web`ディレクトリ以下に存在すればそのテンプレートを処理し、応答します。

#### `*.js` ####

拡張子を`.htpl`に変換したファイルが`web`ディレクトリ以下に存在すればそのテンプレートを処理し、応答します。

#### `*.css` ####

拡張子を`.less`に変換したファイルが`web`ディレクトリ以下に存在すればそのファイルをless.cssとしてコンパイルし、応答します。

`@import`文によりlessコンパイラがファイルを読込もうとした場合、`inc`ディレクトリのみが探索対象になります。  

`@url('')`表記を相対リンクで記述する際は、スタイルシートからの相対パスではなくドキュメントルートからの相対パスを記述してください。  
インクルードされたless.cssでも正しく動作するようにURLは変換されます。

### テンプレート処理 ###

テンプレートタグはJavaScriptを実行します。種類は下記の通りです。

#### `[= EXP =]` ####

`EXP`を評価し、値をHTMLエスケープし、出力します。  

例: JavaScriptの三項演算子を使用

	[= items.length <= 0 ? 'empty' : 'list' =]

#### `[@ EXP @]` ####

`EXP`を評価し、値をそのまま出力します(エスケープ処理を行いません)。

#### `[% SCRIPT; %]` ####

`SCRIPT`をJavaScriptとして実行します。

下記のように、一連のJavaScriptコードを分割出来ます。

例: JavaScriptのif文を使用

	[% if (condition) { %]
	[= value =]
	[% } else { %]
	error
	[% } %]

例: sugar.jsのArray#each()を使用

	[% items.each(function(item, index) { %]
	[= item.name =]
	[% }); %]

#### `[? extends PATH/TO.FILE ?]` ####

指定されたファイルを`inc`ディレクトリから読込み、現在のテンプレートの親として展開します。

内部の動作は後述の`include`とかわりませんが、将来的に挙動が変更(区別)される可能性があります。

#### `[? include PATH/TO.FILE ?]` ####

指定されたファイルを`inc`ディレクトリから読込み、展開します。

現在はextendsの別名です。
継承の対象としない純粋なインクルードを行う場合に使用してください。

#### `[? NAME { ?]...[? } NAME ?]` ####

テンプレートセクションを定義し、また拡張します。  
テンプレートセクション内に`[? base ?]`を記述すると拡張元のテンプレートで出力される内容が展開されます。

セクションの終了タグの`NAME`は省略可能ですが、可読性の点から記述を推奨します。

#### テンプレート変数 `tmpl.timestamp` ####

テンプレート処理を行った日時のUNIXタイムスタンプが設定されます。

例: 外部スクリプトファイルの読込み

	<script src="~/script/at.pkgs.js?[= tmpl.timestamp =]"></script>

#### テンプレート変数 `tmpl.path` ####

テンプレートファイルの仮想パス(プリプロセス後のリクエストパス)になります。

例: クライアントが`/default.html`をリクエストし、`web/default.htpl`がレンダリングされる場合

	/default.html

クライアント実行時
--------

### テンプレート処理 ###

テンプレートタグはJavaScriptを実行します。種類は下記の通りです。

#### `{= EXP =}` ####

`EXP`を評価し、値をHTMLエスケープし、出力します。  

例: JavaScriptの三項演算子を使用

	<table class="{= items.length <= 0 ? 'empty' : 'list' =}">
	...
	</table>

#### `{@ EXP @}` ####

`EXP`を評価し、値をそのまま出力します(エスケープ処理を行いません)。

#### `{% SCRIPT; %}` ####

`SCRIPT`をJavaScriptとして実行します。

下記のように、一連のJavaScriptコードを分割出来ます。

例: JavaScriptのif文を使用

	{% if (condition) { %}
	<p>{= value =}</p>
	{% } else { %}
	<p class="error">error!</p>
	{% } %}

例: sugar.jsのArray#each()を使用

	{% items.each(function(item, index) { %}
	<li>{= item.name =}</li>
	{% }); %}

JavaScript+sugar.js
--------

サーバテンプレート処理時にはデフォルトでsugar.jsが組み込まれています。  
ここでは、sugar.jsを使用したテンプレート記述の関するtipsを記載します。

詳細は [sugar.js公式サイト](http://sugarjs.com/) を参照ください。

### 制御構造 ###

#### 配列ループ `Array#each(function(VALUE, INDEX){...})` ####

リスト表示などに頻出する構造となります。

例: シンプルなループ

	[% items.each(function(value) { %]
	...
	[= value =]
	...
	[% }); %]

例: インデックス(添え字)を使用#1

	[% items.each(function(value, index) { %]
	...
	No.[= index + 1 =]: [= value =]
	...
	[% }); %]

例: インデックス(添え字)を使用#2

	[% items.each(function(value, index) { %]
	<li class="[= index % 2 ? 'even' : 'odd' =]">
	...
	[= value =]
	...
	</li>
	[% }); %]

例: `this`(配列への参照)を使用

	[% items.each(function(value, index) { %]
	<li class="
			[= index == 0 ? 'first' : '' =]
			[= index == this.length - 1 ? 'last' : '' =]
			[= this.length == 1 ? 'single' : '' =]">
	...
	[= value =]
	...
	</li>
	[% }); %]

#### 範囲配列生成 `Number#range(FROM, TO).every()` ####

FROMからTOまでの値を持つ配列を生成します。  
条件でフィルタしたり文字列版String#range()などのバリエーションもあります。

詳細は [sugar.js#ranges](http://sugarjs.com/ranges) を参照ください。

### 出力フォーマット ###

#### 数値フォーマット `Number#pad(NUM)` ####

`Number`型変数の`pad()`メソッドを使用して数値の桁埋めが可能です。  
符号の有無や埋め草の指定なども可能です。

詳細は [sugar.js#Number#pad()](http://sugarjs.com/api/Number/pad) を参照ください。

例: class名に変数`type`から頭`0`埋め2桁で`type_XX`を指定

	<li class="type_[= type.pad(2) =]"></li>

#### 数値フォーマット `Number#format(NUM)` ####

`Number`型変数の`format()`メソッドを使用して数値のフォーマットが可能です。

詳細は [sugar.js#Number#format()](http://sugarjs.com/api/Number/format) を参照ください。

例: `1,234.00`を出力

	[= new Number(1234.00).format(2) =]

例: `1'234,00`を出力

	[= new Number(1234.00).format(2, "'", ',') =]

#### 日付・日時・時刻フォーマット `Date#format(FORMAT)` ####

`Date`型変数の`format()`メソッドを使用して日時のフォーマットが可能です。

詳細は [sugar.js#dates#formatting](http://sugarjs.com/dates#formatting_dates) を参照ください。

例: 変数 `timestamp` 出力

	[= timestamp.format('{yyyy}年{MM}月{dd}日 {HH}:{mm}') =]

### 日時操作 ###

sugar.jsは豊富な`Date`型操作メソッドを提供しています。

なお、sugar.jsの`Date`型操作メソッドは内部値を直接変更してしまうため、テンプレート内で操作をする場合は明示的に`clone()`メソッドを呼び出し、複製を操作する必要があります。
ループ内のカーソルなど、値自体を変更したい場合はこの限りではありません。

詳細は [sugar.js#dates#manipulating](http://sugarjs.com/dates#manipulating_dates) を参照ください。

例: 変数 `timestamp` の前月末日の0時0分を出力

	[= timestamp.clone().biginningOfMonth().addDays(-1)
			.format('{yyyy}-{MM}-{dd} {HH}:{mm}') =]
